<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weight Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjs/lib/browser/math.js"></script>
    <style>
      :root {
        --purple: #5b3d9a;
        --red-soft: #ffeaea;
        --red-border: #e89a9a;
        --bg: #f9fafc;
        --white: #fff;
      }

      body {
        font-family: system-ui, sans-serif;
        padding: 1rem;
        margin: 0 auto;
        max-width: 900px;
        background: var(--bg);
        line-height: 1.4;
      }

      h1 {
        text-align: center;
        margin-bottom: 1rem;
        font-size: clamp(1.4rem, 4vw, 2rem);
      }

      .category {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 0.7rem 1rem;
        margin-bottom: 0.7rem;
        background: var(--white);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: background-color 0.2s ease;
        word-wrap: break-word;
      }

      .invalid {
        background: var(--red-soft) !important;
        border-color: var(--red-border);
      }

      .badge {
        background: #e57373;
        color: white;
        font-size: 0.7rem;
        border-radius: 5px;
        padding: 2px 6px;
        margin-left: 6px;
      }

      .category-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 0.4rem;
      }

      .subcats {
        margin-left: 1rem;
        margin-top: 0.5rem;
      }

      button {
        margin: 0.2rem;
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
        cursor: pointer;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: var(--white);
        color: var(--purple);
        position: relative;
        touch-action: manipulation;
      }

      button:hover {
        background: #f2f2f2;
      }

      #chartContainer {
        margin-top: 1.5rem;
        width: 100%;
        overflow-x: auto;
      }

      canvas {
        width: 100% !important;
        height: 320px !important;
      }

      table {
        border-collapse: collapse;
        margin-top: 1rem;
        width: 100%;
        font-size: 0.9rem;
      }

      th,
      td {
        border: 1px solid #ccc;
        padding: 6px 10px;
        text-align: left;
      }

      th {
        background: #eee;
      }

      @media (max-width: 600px) {
        body {
          padding: 0.5rem;
        }

        .category {
          padding: 0.6rem 0.8rem;
        }

        button {
          font-size: 0.75rem;
          padding: 0.3rem 0.5rem;
        }

        th,
        td {
          font-size: 0.8rem;
          padding: 5px;
        }

        canvas {
          height: 260px !important;
        }
      }
    </style>
  </head>

  <body>
    <h1>üìä Weight Tool</h1>

    <div id="categories"></div>

    <div
      style="
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
      "
    >
      <button onclick="addCategory()">‚ûï Add Category</button>
      <button onclick="resetAll()">üîÑ Reset</button>
      <button onclick="finalize()">‚úÖ Finalize</button>
    </div>

    <div id="chartContainer">
      <canvas id="chart"></canvas>
    </div>

    <div id="results"></div>

    <script>
      let categories = [];
      let myChart = null;

      // Parse weight as fraction of 1 (e.g. 1/3, 0.25, 0.5)
      function parseWeightInput(str) {
        if (!str) return math.fraction(0);
        str = str.trim();
        try {
          return math.fraction(str);
        } catch {
          const num = parseFloat(str);
          if (isNaN(num)) return math.fraction(0);
          return math.fraction(num);
        }
      }

      const f2n = (f) => (typeof f === "number" ? f : math.number(f));

      function addCategory(parent = null) {
        const name = prompt("Category name:");
        if (!name) return;
        const weightStr = prompt(
          "Weight (fraction of 1, e.g. 1/3, 0.5, 0.25):",
          "0.1",
        );
        const weight = parseWeightInput(weightStr);
        const newCat = { name, weight, subs: [] };
        if (parent) parent.subs.push(newCat);
        else categories.push(newCat);
        render();
      }

      function addSubCategory(indexPath) {
        const cat = getCategoryByIndexPath(indexPath);
        addCategory(cat);
      }

      function removeCategory(indexPath) {
        if (!confirm("Are you sure you want to delete this category?")) return;
        if (indexPath.length === 1) {
          categories.splice(indexPath[0], 1);
        } else {
          const parent = getCategoryByIndexPath(indexPath.slice(0, -1));
          parent.subs.splice(indexPath[indexPath.length - 1], 1);
        }
        render();
      }

      function autoGenerateItems(indexPath) {
        const cat = getCategoryByIndexPath(indexPath);
        const numItems = parseInt(prompt("How many items to generate?", "5"));
        if (!numItems || numItems < 1) return;
        cat.subs = [];
        const subWeight = math.fraction(1 / numItems);
        for (let i = 0; i < numItems; i++) {
          cat.subs.push({
            name: `${cat.name} Item ${i + 1}`,
            weight: subWeight,
            subs: [],
          });
        }
        render();
      }

      function getCategoryByIndexPath(path) {
        return path.reduce((acc, idx) => acc.subs[idx], { subs: categories });
      }

      function resetAll() {
        if (!confirm("Reset all categories?")) return;
        categories = [];
        render();
      }

      function subcategoriesValid(subs) {
        if (!subs || subs.length === 0) return true;
        let sum = math.fraction(0);
        for (const c of subs) sum = math.add(sum, c.weight);
        const sumNum = f2n(sum);
        return Math.abs(sumNum - 1) < 0.0001;
      }

      function validatePercentages(list, prefix = "") {
        let warnings = [];
        if (list === categories) {
          let rootSum = math.fraction(0);
          for (const c of list) rootSum = math.add(rootSum, c.weight);
          if (Math.abs(f2n(rootSum) - 1) > 0.0001)
            warnings.push(
              `Root categories sum ${(f2n(rootSum) * 100).toFixed(2)}%`,
            );
        }
        for (const cat of list) {
          if (cat.subs.length > 0) {
            let subSum = math.fraction(0);
            for (const c of cat.subs) subSum = math.add(subSum, c.weight);
            const subSumNum = f2n(subSum);
            if (Math.abs(subSumNum - 1) > 0.0001)
              warnings.push(
                `${prefix ? prefix + " / " : ""}${cat.name} ‚Üí sums ${(subSumNum * 100).toFixed(2)}%`,
              );
            warnings = warnings.concat(
              validatePercentages(
                cat.subs,
                prefix ? `${prefix} / ${cat.name}` : cat.name,
              ),
            );
          }
        }
        return warnings;
      }

      function render() {
        const container = document.getElementById("categories");
        const rootValid = subcategoriesValid(categories);
        container.innerHTML = `
        <div class="category ${!rootValid ? "invalid" : ""}">
          <div class="category-header">
            <div><b>All categories</b> ${!rootValid ? "<span class='badge'>‚ö† Incomplete</span>" : ""}</div>
          </div>
          <div class='subcats'>
            ${renderCategories(categories, [])}
          </div>
        </div>
      `;
        updateChart();
        document.getElementById("results").innerHTML = "";
      }

      function renderCategories(list, path) {
        return list
          .map((cat, i) => {
            const thisPath = [...path, i];
            const invalid =
              cat.subs.length > 0 && !subcategoriesValid(cat.subs);
            const pct = f2n(cat.weight) * 100;
            return `
          <div class="category ${invalid ? "invalid" : ""}">
            <div class="category-header">
              <div>
                <b>${cat.name}</b> (${pct.toFixed(2)}%)
                ${invalid ? "<span class='badge'>‚ö† Incomplete</span>" : ""}
              </div>
              <div>
                <button title="Delete category" onclick='removeCategory([${thisPath}])'>‚ùå</button>
                ${cat.subs.length === 0 ? `<button title="Auto generate equal sub-items" onclick='autoGenerateItems([${thisPath}])'>üß©</button>` : ""}
                <button title="Add subcategory" onclick='addSubCategory([${thisPath}])'>‚ûï</button>
              </div>
            </div>
            ${cat.subs.length ? `<div class='subcats'>${renderCategories(cat.subs, thisPath)}</div>` : ""}
          </div>
        `;
          })
          .join("");
      }

      function collectAllWeights(
        list,
        prefix = "",
        parentWeight = math.fraction(1),
      ) {
        let items = [];
        for (const cat of list) {
          const fullName = prefix ? `${prefix} / ${cat.name}` : cat.name;
          const totalWeight = math.multiply(parentWeight, cat.weight);
          if (cat.subs.length === 0) {
            items.push({
              name: fullName,
              local: cat.weight,
              total: totalWeight,
            });
          } else {
            items = items.concat(
              collectAllWeights(cat.subs, fullName, totalWeight),
            );
          }
        }
        return items;
      }

      function finalize() {
        try {
          const problems = validatePercentages(categories);
          if (problems.length > 0) {
            alert("‚ö†Ô∏è Some categories don't sum to 1:\n" + problems.join("\n"));
            return;
          }
          const items = collectAllWeights(categories);
          if (items.length === 0) {
            alert("‚ö†Ô∏è No leaf categories defined.");
            return;
          }

          const validItems = items.filter((it) => f2n(it.total) > 0);
          const fractions = validItems.map((it) => it.total);
          const denoms = fractions.map((f) => Number(f.d));
          const lcm = denoms.reduce((a, b) => math.lcm(a, b), 1);
          const integers = fractions.map(
            (f) => Number(f.n) * (lcm / Number(f.d)),
          );
          const gcd = integers.reduce((a, b) => math.gcd(a, b));
          const finalInts = integers.map((v) => v / gcd);

          let html = `
          <h2>üßÆ Final integer weights</h2>
          <table>
            <tr><th>Item</th><th>Local %</th><th>Total %</th><th>Integer Value</th></tr>
        `;
          validItems.forEach((it, i) => {
            html += `<tr>
            <td>${it.name}</td>
            <td>${(f2n(it.local) * 100).toFixed(2)}%</td>
            <td>${(f2n(it.total) * 100).toFixed(4)}%</td>
            <td><b>${finalInts[i]}</b></td>
          </tr>`;
          });
          html += "</table>";
          document.getElementById("results").innerHTML = html;
        } catch (err) {
          console.error(err);
          alert("‚ùå Error while computing results.");
        }
      }

      function updateChart() {
        const canvas = document.getElementById("chart");
        const ctx = canvas.getContext("2d");
        if (myChart) myChart.destroy();
        const items = collectAllWeights(categories);
        if (items.length === 0) return;
        myChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: items.map((i) => i.name),
            datasets: [
              {
                label: "Total Weight (%)",
                data: items.map((i) => f2n(i.total) * 100),
                backgroundColor: "#6c63ff55",
                borderColor: "#6c63ff",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "Total %" },
              },
            },
          },
        });
      }

      render();
    </script>
  </body>
</html>
